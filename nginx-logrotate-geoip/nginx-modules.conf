# Load dynamic modules
load_module modules/ngx_http_geoip2_module.so;
load_module modules/ngx_http_brotli_filter_module.so; 
load_module modules/ngx_http_brotli_static_module.so;

# Example configuration for GeoIP2 module
http {
    # GeoIP2 configuration
    geoip2 /usr/share/GeoIP/GeoLite2-Country.mmdb {
        auto_reload 5m;
        $geoip2_metadata_country_build metadata build_epoch;
        $geoip2_data_country_code default=US source=$remote_addr country iso_code;
        $geoip2_data_country_name country names en;
    }

    geoip2 /usr/share/GeoIP/GeoLite2-City.mmdb {
        $geoip2_data_city_name default=London city names en;
        $geoip2_data_postal_code postal code;
        $geoip2_data_latitude location latitude;
        $geoip2_data_longitude location longitude;
        $geoip2_data_time_zone location time_zone;
    }

    # Brotli configuration
    brotli on;
    brotli_comp_level 6;
    brotli_buffers 16 8k;
    brotli_min_length 20;
    brotli_types
        text/plain
        text/css
        text/xml
        text/javascript
        text/json
        application/json
        application/javascript
        application/xml+rss
        application/atom+xml
        image/svg+xml;

    # Add headers for debugging
    add_header X-Country-Code $geoip2_data_country_code;
    add_header X-Country-Name $geoip2_data_country_name;
    add_header X-City-Name $geoip2_data_city_name;

    server {
        listen 80;
        
        location / {
            root /usr/share/nginx/html;
            index index.html;
            
            # Enable brotli for this location
            brotli_static on;
        }

        # Status endpoint to check GeoIP data
        location /geoip-status {
            default_type application/json;
            return 200 '{"country_code":"$geoip2_data_country_code","country_name":"$geoip2_data_country_name","city":"$geoip2_data_city_name","latitude":"$geoip2_data_latitude","longitude":"$geoip2_data_longitude"}';
        }
    }
}